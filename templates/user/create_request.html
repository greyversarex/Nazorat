{% extends "base.html" %}

{% block title %}Дархости нав - Systemi Darkhostho{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="bi bi-plus-circle me-2"></i>Дархости нав
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="requestForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-4">
                        <label for="topic_id" class="form-label">
                            <i class="bi bi-tag me-1"></i>Мавзӯъ <span class="text-danger">*</span>
                        </label>
                        <select class="form-select form-select-lg" id="topic_id" name="topic_id" required>
                            <option value="">Мавзӯъро интихоб кунед...</option>
                            {% for topic in topics %}
                                <option value="{{ topic.id }}">{{ topic.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label">
                            <i class="bi bi-geo-alt me-1"></i>Ҷойгиршавӣ
                        </label>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                        
                        <div class="d-flex gap-2 align-items-center">
                            <button type="button" 
                                    id="getLocationBtn" 
                                    class="btn btn-outline-success btn-lg flex-grow-1">
                                <i class="bi bi-crosshair me-2"></i>Муайян кардани ҷойгиршавӣ
                            </button>
                            <span id="locationStatus" style="display: none;">
                                <i class="bi bi-check-circle-fill text-success fs-3"></i>
                            </span>
                        </div>
                        <div id="locationInfo" class="mt-2 small text-muted" style="display: none;">
                            <i class="bi bi-pin-map me-1"></i>
                            <span id="locationCoords"></span>
                        </div>
                        <div id="locationMapBox" class="mt-3" style="display: none;">
                            <div id="locationMap" style="height: 250px; width: 100%; border-radius: 8px;"></div>
                        </div>
                        <div id="locationError" class="mt-2 text-danger small" style="display: none;"></div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="comment" class="form-label">
                            <i class="bi bi-chat-text me-1"></i>Шарҳ / Тавсиф
                        </label>
                        <textarea class="form-control" 
                                  id="comment" 
                                  name="comment" 
                                  rows="4"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label for="media" class="form-label">
                            <i class="bi bi-paperclip me-1"></i>Расм ё видео
                        </label>
                        <input type="file" 
                               class="form-control form-control-lg" 
                               id="media" 
                               name="media"
                               accept="image/*,video/*">
                        <div class="form-text">
                            Форматҳои иҷозатшуда: PNG, JPG, GIF, MP4, MOV, AVI, WEBM (ҳадди аксар 50MB)
                        </div>
                        <div id="mediaPreview" class="mt-2" style="display: none;">
                            <img id="imagePreview" class="img-thumbnail" style="max-height: 200px; display: none;">
                            <video id="videoPreview" style="max-height: 200px; display: none;" controls></video>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                            <i class="bi bi-send me-1"></i>Равон кардан
                        </button>
                        <a href="{{ url_for('user.dashboard') }}" class="btn btn-outline-secondary btn-lg">
                            <i class="bi bi-x-lg me-1"></i>Бекор
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var map = null;
    var mapReady = false;
    
    function initMap(lat, lng) {
        var container = document.getElementById('locationMapBox');
        var mapDiv = document.getElementById('locationMap');
        
        container.style.display = 'block';
        
        if (map) {
            map.remove();
            map = null;
        }
        
        mapDiv.innerHTML = '';
        
        setTimeout(function() {
            map = L.map('locationMap').setView([lat, lng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);
            L.marker([lat, lng]).addTo(map).bindPopup('Ҷойгиршавии шумо').openPopup();
            
            map.invalidateSize();
            setTimeout(function() { map.invalidateSize(); }, 300);
        }, 50);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        var btn = document.getElementById('getLocationBtn');
        var latInput = document.getElementById('latitude');
        var lngInput = document.getElementById('longitude');
        var status = document.getElementById('locationStatus');
        var info = document.getElementById('locationInfo');
        var coords = document.getElementById('locationCoords');
        var error = document.getElementById('locationError');
        
        btn.onclick = function() {
            if (!navigator.geolocation) {
                error.textContent = 'Браузери шумо геолокацияро дастгирӣ намекунад.';
                error.style.display = 'block';
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Ҷустуҷӯ...';
            error.style.display = 'none';
            
            navigator.geolocation.getCurrentPosition(
                function(pos) {
                    var lat = pos.coords.latitude;
                    var lng = pos.coords.longitude;
                    
                    latInput.value = lat;
                    lngInput.value = lng;
                    
                    status.style.display = 'inline';
                    info.style.display = 'block';
                    coords.textContent = lat.toFixed(6) + ', ' + lng.toFixed(6);
                    
                    initMap(lat, lng);
                    
                    btn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Ҷойгиршавӣ муайян шуд';
                    btn.className = 'btn btn-success btn-lg flex-grow-1';
                    btn.disabled = false;
                },
                function(err) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-crosshair me-2"></i>Муайян кардани ҷойгиршавӣ';
                    
                    var msg = 'Хато дар гирифтани ҷойгиршавӣ.';
                    if (err.code === 1) msg = 'Дастрасӣ ба ҷойгиршавӣ рад карда шуд.';
                    if (err.code === 2) msg = 'Маълумоти ҷойгиршавӣ дастнорас аст.';
                    if (err.code === 3) msg = 'Вақти дархост гузашт.';
                    
                    error.textContent = msg;
                    error.style.display = 'block';
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        };
        
        var mediaInput = document.getElementById('media');
        var mediaPreview = document.getElementById('mediaPreview');
        var imgPreview = document.getElementById('imagePreview');
        var vidPreview = document.getElementById('videoPreview');
        
        mediaInput.onchange = function(e) {
            var file = e.target.files[0];
            if (!file) {
                mediaPreview.style.display = 'none';
                return;
            }
            
            var url = URL.createObjectURL(file);
            
            if (file.type.indexOf('image') === 0) {
                imgPreview.src = url;
                imgPreview.style.display = 'block';
                vidPreview.style.display = 'none';
                mediaPreview.style.display = 'block';
            } else if (file.type.indexOf('video') === 0) {
                vidPreview.src = url;
                vidPreview.style.display = 'block';
                imgPreview.style.display = 'none';
                mediaPreview.style.display = 'block';
            }
        };
    });
})();
</script>
{% endblock %}
